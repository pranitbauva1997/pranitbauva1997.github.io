<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0"><title>Deploying with Heroku</title><link rel=stylesheet href=/style.css><link rel=stylesheet href=https://use.edgefonts.net/c/26d4b4/1w;source-code-pro,2,glz:W:n4,gm5:W:n7;source-sans-pro,2,2cm9PD:W:i2,2cm9PG:W:i3,2cm9PJ:W:i4,2cm9PL:W:i6,2cm9PN:W:i7,2cm9PQ:W:i9,2cm9PC:W:n2,2cm9PF:W:n3,2cm9PH:W:n4,2cm9PK:W:n6,2cm9PM:W:n7,2cm9PP:W:n9;volkhov,2,Wj9:W:i4,WjC:W:i7,WjD:W:n4,WjB:W:n7/l media=all><script>!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('phc_hMCWtDK8me4vyrMX9X7NnxYpZtv9nAStlew5rIKyjt',{api_host:'https://app.posthog.com'})</script><script>(function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
    .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
    n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
    (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
    ml('account', '696461');</script><body><script src=/lib/navbar.js></script><nav class=sticky><section class=navigation><a href=javascript:void(0); class=navigation-item onclick=toggleNavButton()><i class="fa fa-bars icon"></i><span class=nav-menu>Menu</span></a> <a class=navigation-item href="/">HOME</a> <a class=navigation-item href="/annual-reports/">ANNUAL REPORTS</a> <a class=navigation-item href="/blog/">BLOG</a> <a class=navigation-item href="/book-summaries/">BOOK SUMMARIES</a> <a class=navigation-item href="/contact/">CONTACT</a></section></nav><section class=content><h1>Deploying with Heroku</h1><article class=section-content><p>As their <strong>About page</strong> reads:</p><blockquote><p>Heroku is a cloud platform that lets companies build, deliver, monitor and scale apps — we're the fastest way to go from idea to URL, bypassing all those infrastructure headaches.</p></blockquote><p>Heroku is the fastest deployment service that is available right now. One can directly use git to deploy heroku apps with simplicity and ease. The only downside of Heroku is that it can get costly. They only give a few hours of server use per month free, after that it is chargeable. Nevertheless, for small-scale apps it heroku fits perfectly without having the deployment headache. Heroku also integrates with GitHub so you can directly deploy from there.</p><p>You may find a detailed information about heroku from <a href=https://www.heroku.com/what>here</a> and you can know more about how it works from <a href=https://devcenter.heroku.com/articles/how-heroku-works>here</a>.</p><p>To learn about deployment process of Heroku I found an online udacity course named <a href=https://www.udacity.com/course/deploying-applications-with-heroku--ud272><strong>Deploying Web Applications with Heroku</strong></a>.</p><p><strong>Note:</strong> What follows below are notes of that course which I choose to publish online.</p><h1 id=deployment-in-a-flash>Deployment in a Flash</h1><h3 id=what-is-deployment>What is Deployment?</h3><p>When you are working on code, you mostly work on your own PC and test it there itself. That machine is called as <strong>Local Development Environment</strong> or <strong>localhost</strong> when it can be accessed only by you. When you want other people to use your application, you need to put all of the code on some server and execute it there so that your users can use it. Moving the code from the local development environment to the server is called as deployment.</p><h3 id=what-is-heroku>What is Heroku?</h3><p>Heroku will take you application code and make it accessible on the internet with a new simple commands. Heroku is a Platform Service for the developer to upload your code and make it accessible it to everyone. This is called as <strong>Platform as a service</strong> and is one kind of internet product available today along with Infrastructure as a service and Software as a service. PaaS makes it really simple to host the applications online.</p><p>Before services like Heroku, many developers had to maintain servers where they had to think about the server hardware, software, physical location, uptime, security and many more just so that the application runs smoothly. With heroku you can deploy the code with a few commands. Thus the developer can focus more on the application and not on deployment.</p><p><a href=https://devcenter.heroku.com/articles/heroku-cli><strong>How to Install Heroku</strong></a></p><h3 id=basics>Basics</h3><p><strong>Heroku Account</strong>:</p><p>The first thing we need to do is make sure you have a Heroku account created. This will give you access to Heroku’s deployment services and will allow you to manage your deployed applications on their web app. It is free to sign up so visit the <a href="https://www.heroku.com/">Heroku homepage</a> and sign up for an account.</p><p><strong>Heroku Toolbelt:</strong></p><p>The next thing you should do is install the Heroku Toolbelt. The toolbelt is a command line tool that will expand the functionality of your command line to include <code>heroku</code> commands. For example, once installed you will be able to use the <code>heroku login</code> command to log into your account from your command shell. To install the <a href="https://toolbelt.heroku.com/">Heroku Toolbelt</a> navigate to toolbelt.heroku.com and follow the installation instructions for your operating system.</p><p><strong>Heroku Login:</strong></p><p>Once you have your Heroku account and the toolbelt installed you will want to log in to your Heroku account from the command line. To do this, open up your command line shell and type <code>heroku login</code>. This will prompt you for your Heroku email and password. If you entered your information correctly, your command line output should look something like the image below. You won’t have to log in every time you want to deploy, your credentials will be saved for some time, so this is a good command to keep in mind if you get logged out at some point.</p><p><strong>Git Installed</strong>:</p><p>Heroku deploys the most recent version of your app by keeping track of changes via Git. Make sure that you have Git installed on your command shell. If you do not have Git installed you can visit <a href=https://git-scm.com/book/en/v2/Getting-Started-Installing-Git>this link</a> to get yourself set up. Most recent MacOS machines come with Git already installed, and if you have been building applications on your development environment already, it is likely you have already been using Git.</p><p>Clone Repository Now that you have everything you need to get started, you will need to clone the gallery application you are going to deploy. Open up your command line and navigate to the location where you want the repository to live, this is often a projects directory but it can be anywhere you like on your machine as long as it is not within another Git repository. If you are not sure if there is a git repository on your working directory you can check using git status. If you get a message saying <code>fatal: Not a git repository (or any of the parent directories): .git</code>. This means you are not in a Git repo and you can clone in this location. Go to the <a href=https://github.com/udacity/galeria>Udacity repository</a> and copy the clone URL.</p><p>Return to your command line and type <code>git clone</code> followed by the git clone URL you just copied. This will clone the code on GitHub to your computer.</p><p>Once you have installed all the tools and cloned the repository, you are ready to go live. It is generally a good idea to check your <code>git status</code> to make sure you are about to deploy the most updated stable version. Let’s deploy!</p><p><strong>Heroku Create:</strong></p><p>To get yourself deployed on Heroku, you must first create a remote on Git. To do this you have to run the <code>heroku create</code> command. This will make a new remote repo named <code>heroku</code> where the code will be pushed to.</p><p>To ensure you have properly created this remote, run the <code>git remote -v</code> command, you should see something output that reveals the two remotes listed, <code>origin</code> and <code>heroku</code>.</p><p><strong>Git Push Heroku Master</strong></p><p>Now the last step, the ribbon cutting is the command <code>git push heroku master</code>. This command is very similar to the git push that you may be familiar with when pushing your code to GitHub. Instead of pushing it to github via the origin remote, you are pushing it to the heroku remote.</p><p>From this point you will see a large output from Heroku that is listing all of the libraries and tools that are being installed on the Heroku machine before your code is finally decompressed and launched onto the online server.</p><p><strong>Heroku Open</strong></p><p>Once you have your application deployed, Heroku will provide you with a URL you can visit to see your site. After this you can run <code>heroku open</code>. This will open up a browser window and navigate to the deployed application URL.</p><p>Now your gallery is live! Click on the “New Art Piece” button to see a new image appear!</p><h3 id=types-of-deployment>Types of Deployment</h3><p>The different places where your application can live is called as <strong>environments</strong>.</p><p><strong>Development environment:</strong> When you are developing the application on your machine. This is the local host. You are coding as well as testing the application and building features. This is not deployed.</p><p><strong>Production environment:</strong> Making you application available for users. The code needs to be hosted on some server.</p><p><strong>Staging environment:</strong> This is kind of a &quot;live rehearsal&quot; for the production environment. The code is deployed on servers. This includes additional tests and sample data.</p><p><strong>Development pipeline</strong> is the process of developing the application, testing the application on staging area servers and then actually deploying it for the real world users.</p><h1 id=common-functionality>Common Functionality</h1><h3 id=heroku-and-amazon>Heroku and Amazon</h3><p>Heroku internally uses Amazon AWS services for their servers. Heroku takes a fully fledged Amazon AWS server and makes small tiny servers out of it and then rents it individually.</p><h3 id=linux-containers>Linux Containers</h3><p>Virtualized servers that are provided are called as <em>Linux containers</em>. Linux containers on same server don't share files though they share memory and storage resources. Heroku calls their special single command containers as <strong>dynos</strong>.</p><h3 id=procfile>Procfile</h3><p>Heroku will allow you one “dyno” or single command container for free. This means that on a free tier Heroku account, you can run one command on the container and you will not be charged for it. So many commands to choose from, which one will you pick? Well the most straightforward answer would be: <em>the command that will run your application</em>!</p><p>Running your application on Heroku requires explicitly telling the container or dyno to run your application. If you take a look at the <code>Procfile</code> in your gallery app you will see how this command is instructed to run.</p><p>The <code>Procfile</code> specifies a process of type “web”, which Heroku specifies to be the only process type that can accept HTTP traffic, which is necessary for your application to be properly hosted. The command that is being run on the Heroku virtual dyno is <code>bundle exec rackup config.ru</code> with a specified port, shown by <code>-p</code> and the variable <code>$PORT</code>.</p><p>This command will automatically configure a web server with the <code>config.ru</code> specifications that will run on the <code>$PORT</code> port.</p><p>You can see here that <code>config.ru</code> loads the entire contents of the app folder which contains the gallery application. It also fires up Sinatra to run the application, as seen on line 2.</p><p>So now you can see how Heroku is able to know what to do with your code when you push it.</p><p>Heroku is able to recognize the <code>Procfile</code> as a file that will specify a process to run on the dyno. You can see in the terminal output of your Heroku push. It is important to reiterate the the command in the <code>Procfile</code> is not being run on your local environment, it is running on the production dyno where your application is hosted.</p><p>This is a key difference between running your app locally and hosting it on Heroku. If you were running this application locally, all you would have to do is run <code>ruby app.rb</code> to fire up the server and get your application running. The <code>Procfile</code> is specifically included so that Heroku knows what to do with the code you gave it.</p><h3 id=ephemeral-filesystem>Ephemeral Filesystem</h3><p>Heroku works on a short-lived file system. It means that any files which are not the part of source code will be removed periodically. Does this mean that it is not possible to have persistance files on your server? No, you just have to add the database.</p><h3 id=setting-up-a-database>Setting up a Database</h3><p>The repository you cloned in Lesson 1 contained multiple branches that represent different stages of the application. For this step you will need to create a new local branch within your repository and set it to be track the remote “pg” branch. To do this make sure that you are in your repository and run <code>git checkout -b pg origin/pg</code>.</p><p>We named this branch is called “pg” because the database that we have is a PostgreSQL database. There are many databases out there that you can use but Heroku requires that you use PostgreSQL when using a Ruby application. Sinatra doesn’t require any database by default but other frameworks like Rails come with SQLite as a default. SQLite will create a database file in your application directory that will change as your database updates. Because of Heroku’s ephemeral filesystem this changing database file will be eventually reset, meaning it is unsuitable for use with Heroku.</p><p>At this point your application is ready to be deployed, however unless you have PostgreSQL installed in your computer you will not be able to run this application in your localhost. If you do not have PostgreSQL installed follow these guides.</p><ul><li>Mac: Visit http://postgresapp.com/</li><li>Windows: Visit http://www.postgresql.org/download/windows/</li><li>Ubuntu: Visit http://www.postgresql.org/download/linux/ubuntu/</li></ul><p>You may notice when opening this up in your editor that there are many more files present than there were in the version without a database. This is because to get a database working with this Sinatra application you have to have not only the database but also a way for your application to interact with the database, in this case ActiveRecord. ActiveRecord is an ORM or Object Relational Manager that will translate the ruby code to SQL (pronounced sequel) that the database can execute.</p><p>ActiveRecord comes in the form of a gem so you want to make sure that the application is stable locally before it can be deployed online, so run <code>bundle install</code>.</p><p>Now that the required gems are installed on your local system, open the app as you regularly would on your local development environment. Run <code>ruby app.rb</code>. When you try to open the application by visiting localhost:4567 you see that we have a Sinatra error.</p><div class=image-container><img src=&#x2F;images&#x2F;blog&#x2F;heroku&#x2F;1.png alt="" class=image></div><p>Here we see that the table that needs to be in the database does not yet exist. You need to create it. Return to the command line, shut the server down and run <code>rake db:migrate</code>.</p><p>Now that you have created the table required, go ahead and fire up the server again with <code>ruby app.rb</code> and navigate to it on your browser.</p><p>To push your <code>pg</code> branch to the Heroku remote make sure that you are on the pg branch (you can check by running <code>git branch</code>) and run this command: <code>git push heroku HEAD:master</code>.</p><p>This command will ensure that the code that is pushed to heroku master is the one that is at HEAD. In this case, this is the <code>pg</code> branch.</p><p>Once you do this open the application by running <code>heroku open</code>.</p><div class=image-container><img src=&#x2F;images&#x2F;blog&#x2F;heroku&#x2F;2.png alt="" class=image></div><p>You will see that we get an internal server error. Well if you recall, when running the application locally you had to run the database migrations. To run a command on your Heroku server you have to prepend the command with <code>heroku run</code>. This will tell Heroku that you want to run a command on the live server, much like you would when you are running it on localhost. So instead of <code>rake db:migrate</code>, try <code>heroku run rake db:migrate</code>.</p><p>Well that’s strange, it looks different than the different error you got last time about the undefined PG table. It looks here that Heroku is not able to find a database connection.</p><p>This happened because you do not have a PostgreSQL addon included in Heroku. Heroku will only automatically include the PostgreSQL addon if your very first deploy includes the gem <code>pg</code> in the Gemfile. This is your second deploy to the same Heroku application so it is not included. To include this addon run <code>heroku addons:create heroku-postgresql</code>.</p><p>Now try running the database migrations again in the Heroku server by using heroku run <code>heroku run rake db:migrate</code>.</p><p><strong>Note:</strong> Here you might get an error like <code>Cannot run more than 1 Free size dynos</code>. This is because you already have a service running on a dyno and you need to shut it down first before trying to create the database.</p><p>Great it looks like you’re almost there. Check if your page is up by refreshing it.</p><p>You have now successfully deployed the version of the Udacity Gallery application with a database!</p><p>Let’s recap the takeaways here:</p><ul><li>Running commands on your Heroku server is different than running those same commands on your local computer.<ul><li>Prepend your commands with <code>heroku run</code>.</li></ul></li><li>Installing a database on your Heroku server is not always automatic.<ul><li>If your first deploy contains the pg gem, then Heroku will include the <code>heroku-postgresql</code> addon.</li><li>If your application does not start with a postgres database but you want to add it you must run the <code>heroku addons:create heroku-postgresql</code>.</li></ul></li></ul><h3 id=log-intro>Log Intro</h3><p>The heroku app just shows <code>Internal Server Error</code> when we didn't run the migrations but the local environment showed a detailed output of the error.</p><p>This is because of:</p><ul><li>We want to hide complex errors from users.</li><li>The errors might give out sensitive data which can be pose security issues.</li></ul><h3 id=log-types>Log Types</h3><p>If you run into error into the production server, you have to use <code>Heroku Logplex</code> which is a collection of log output from different places.</p><p>The types of logs are:</p><ul><li><p>Application Logs:</p><ul><li>Deployed application logs</li><li>Same as your command line</li><li>Mirrors development environment</li></ul></li><li><p>System Logs:</p><ul><li>What Heroku is doing</li><li>Routing</li><li>Starting/Stopping the dyno</li></ul></li><li><p>Administrative Logs:</p><ul><li>Administrative actions</li><li>Rake tasks</li><li>New build</li></ul></li></ul><p>It is very important to know where the error occurred and thus we should be able to read the log output nicely and be able to differentiate between the types of log outputs.</p><h3 id=log-structure>Log Structure</h3><p><code>heroku logs</code> will give the log output. This output can be divided into four parts namely timestamp, app/heroku (who is doing that thing), dyno, and finally the log message.</p><p>One can use <code>heroku logs --tail</code> to collect logs in realtime.</p><p>For a detailed description about heroku logs, visit <a href=https://devcenter.heroku.com/articles/logging>here</a>.</p><h3 id=ending-note>Ending note</h3><p>Heroku has a problem of file storage which can be fixed by using Amazon S3 storage.</p><p>Also, some interesting topics to look into are:</p><ul><li><a href=https://devcenter.heroku.com/articles/multiple-environments#managing-staging-and-production-configurations>Creating a staging environment</a></li><li><a href=https://devcenter.heroku.com/articles/background-jobs-queueing>Scheduling Workers</a></li><li><a href=https://devcenter.heroku.com/articles/codeship>Continuous Integration</a></li></ul><p>This was a wonderful course, and I gained lots of useful information about heroku deployment!</p></article><div class=ml-embedded data-form=OIxuLV></div></section><footer><section class=footer-content><i class="fa fa-copyright footer-element"></i><p class=footer-element>Pranit Bauva</p></section></footer><script src=https://use.fontawesome.com/1ceb47dcca.js></script><script>(function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
    .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
    n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
    (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
    ml('account', '696461');</script>